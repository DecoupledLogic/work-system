# Work Item Directories Implementation Plan

This document defines the implementation plan for adding per-work-item directory structure to the work system.

## Background

### Inspiration

The pattern comes from `/home/cbryant/projects/link/atlas/dev-support/tasks/tw-26253606/` which provides a "structured home" for a work item containing:

- `delivery-plan.md` - Master specification
- `delivery-log.csv` - Metrics with timestamps, cycle/lead times
- `estimate.csv` - Hour breakdown by epic/feature/story
- `presentation-deck.md` - Multi-audience communication
- `specs/` - Feature specs and delivery workflow
- `research/` - Background documentation

### Current State

Documents are currently organized by **type** (scattered across categories):

```
docs/
├── prd/TW-12345-feature-name.md
├── specs/TW-12345-feature-name.md
├── plans/TW-12345-impl-plan.md
└── bugs/TW-12345-bug-report.md
```

Session state is **global** (not per-work-item):

```
~/.claude/session/
├── active-work.md      # Current work context (one at a time)
├── session-log.md      # All runs/actions (all work items)
└── queues.json         # Queue assignments
```

### Gap

No consolidated "home" per work item. Documents scattered. No cross-session activity history specific to a work item.

## Proposed Structure

```
work-items/
├── tw-26253606/                    # Teamwork work item
│   ├── work-item.yaml              # Metadata & status snapshot
│   ├── activity-log.md             # Cross-session action history
│   ├── delivery-plan.md            # Generated by document-writer
│   ├── prd.md                      # Product requirements
│   ├── spec.md                     # Technical specification
│   ├── impl-plan.md                # Implementation plan
│   ├── test-plan.md                # Test strategy
│   ├── estimate.csv                # Hour breakdown (optional)
│   ├── adr/                        # Work-item-specific ADRs
│   │   └── 001-approach-choice.md
│   └── research/                   # Supporting research
│       └── api-investigation.md
├── gh-456/                         # GitHub issue
│   └── ...
└── ado-123/                        # Azure DevOps work item
    └── ...
```

### Directory Naming Convention

Format: `{prefix}-{id}` (lowercase)

| Prefix | System | Example |
|--------|--------|---------|
| `tw` | Teamwork | `tw-26253606` |
| `gh` | GitHub | `gh-456` |
| `ado` | Azure DevOps | `ado-123` |
| `wi` | Internal (no external system) | `wi-001` |

## Key Components

### 1. Work Item Metadata (`work-item.yaml`)

Snapshot of normalized work item data:

```yaml
id: tw-26253606
name: Subscription Renewal System
externalSystem: teamwork
externalId: "26253606"
externalUrl: https://company.teamwork.com/tasks/26253606
type: epic
status: in_progress
stage: design
queue: standard
createdAt: 2025-12-09T14:30:00Z
initializedAt: 2025-12-09T14:30:00Z
updatedAt: 2025-12-10T09:15:00Z
```

### 2. Activity Log (`activity-log.md`) - Tracked in Git

High-level, team-facing history of significant events:

```markdown
# Activity Log: tw-26253606

## Summary

| Metric | Value |
|--------|-------|
| Initialized | 2025-12-09 |
| Current Stage | design |
| Artifacts | 4 |

---

## Timeline

### 2025-12-10 - Design Stage

- Completed design exploration
- Created implementation plan (5 tasks)
- **Artifacts:** impl-plan.md, adr/001-approach-choice.md
- **Decision:** Chose webhook-based approach over polling

### 2025-12-09 - Plan Stage

- Decomposed into 3 features, 12 stories
- Estimated 45 hours total
- **Artifacts:** delivery-plan.md, estimate.csv

### 2025-12-09 - Initialized

- Created from Teamwork task 26253606
- Type: epic, Queue: standard
```

### 3. Session Notes (`session-notes.md`) - Gitignored

Detailed, personal notes for the current developer (not tracked):

```markdown
# Session Notes: tw-26253606

## 2025-12-10 ses-20251210-091000

### Design exploration notes
- Tried polling approach first, too slow
- Webhook latency ~200ms acceptable
- Need to handle retry logic for failed deliveries

### Questions to resolve
- [ ] Confirm webhook endpoint with ops team
- [ ] Check rate limits on external API
```

### 4. Relationship to Session Logging

| Aspect | Session Log | Activity Log | Session Notes |
|--------|-------------|--------------|---------------|
| **Scope** | Claude session | Work item | Work item |
| **Lifespan** | Ephemeral | Persistent | Ephemeral |
| **Git** | Ignored | Tracked | Ignored |
| **Location** | `~/.claude/session/` | `work-items/{id}/` | `work-items/{id}/` |
| **Content** | Tool calls, tokens | Stage events, artifacts | Personal notes |
| **Audience** | Developer (debug) | Team (history) | Developer (scratch) |

**They are complementary:**

- **Session log** captures the *how* (detailed tool calls, token usage) - global
- **Activity log** captures the *what* (stage transitions, artifacts) - team-facing
- **Session notes** captures the *thinking* (personal notes, questions) - individual

### 5. Document Output Paths

Updated document-writer behavior:

| Document Type | Current Path | New Path |
|---------------|--------------|----------|
| PRD | `docs/prd/TW-12345-name.md` | `work-items/tw-12345/prd.md` |
| Spec | `docs/specs/TW-12345-name.md` | `work-items/tw-12345/spec.md` |
| Impl Plan | `docs/plans/TW-12345-name.md` | `work-items/tw-12345/impl-plan.md` |
| Bug Report | `docs/bugs/TW-12345-name.md` | `work-items/tw-12345/bug-report.md` |
| Test Plan | `docs/plans/TW-12345-test.md` | `work-items/tw-12345/test-plan.md` |
| ADR (global) | `~/.claude/docs/adr/ADR-NNNN.md` | (unchanged - global) |
| ADR (local) | - | `work-items/tw-12345/adr/NNN-title.md` |
| Strategy | `~/.claude/docs/strategy/` | (unchanged - global) |

## Implementation Phases

### Phase 1: Directory Structure & Initialization

**Goal:** Create work-item directory infrastructure

**Deliverables:**

1. **Directory schema** (`schema/work-item-directory.schema.md`)
   - Define required/optional files
   - Define activity-log entry format
   - Define work-item.yaml schema

2. **Initialization logic** (update stage agents)
   - `/workflow:triage` creates directory if not exists
   - Writes initial `work-item.yaml`
   - Creates empty `activity-log.md` with header

3. **Helper command** (`/work-item init`)
   - Manual initialization for edge cases
   - Accepts `{prefix}-{id}` argument

### Phase 2: Activity Logging Integration

**Goal:** Connect session logger to activity log

**Deliverables:**

1. **Session logger update** (`agents/session-logger.md`)
   - New action: `log_to_work_item`
   - Writes to `work-items/{id}/activity-log.md`
   - Called at stage start/complete

2. **Stage agent updates**
   - Each stage logs start/complete to activity log
   - Includes artifacts created, decisions made

### Phase 3: Document Writer Integration

**Goal:** Update document output paths

**Deliverables:**

1. **Document writer update** (`agents/document-writer-agent.md`)
   - Accept `workItemDir` in context
   - Output to work-item directory when provided

2. **Command updates** (`/docs:write`)
   - Auto-detect active work item
   - Route output to work-item directory

### Phase 4: Cross-Session Context

**Goal:** Use activity log for context recovery

**Deliverables:**

1. **Context loader** (update `/workflow:resume`)
   - Read `activity-log.md` for history
   - Summarize previous sessions
   - Identify last stage and artifacts

2. **Work item status** (`/work-item status`)
   - Display activity summary
   - Show artifacts present
   - Show current stage

## Files to Create/Modify

### New Files

| File | Purpose |
|------|---------|
| `schema/work-item-directory.schema.md` | Directory structure definition |
| `docs/adrs/0006-work-item-directories.md` | ADR for this decision |
| `templates/work-item.yaml.template` | Initial work-item.yaml |
| `templates/activity-log.md.template` | Initial activity-log.md |
| `templates/session-notes.md.template` | Initial session-notes.md |

### Modified Files

| File | Changes |
|------|---------|
| `agents/session-logger.md` | Add `log_to_work_item` action |
| `agents/workflow:triage-agent.md` | Initialize directory on triage |
| `agents/document-writer-agent.md` | Support work-item directory output |
| `commands/docs:write.md` | Route to work-item directory |
| `commands/workflow:resume.md` | Read activity log for context |
| `docs/agents/document-writer-agent.md` | Update path documentation |
| `.gitignore` | Add `work-items/*/session-notes.md` |
| `docs/.gitignore.worksystem` | Add `work-items/*/session-notes.md` |

## Design Decisions

1. **Git tracking?** → Hybrid approach:
   - `activity-log.md` → Tracked (team-facing history)
   - `session-notes.md` → Gitignored (personal scratch notes)
2. **Document duplication?** → Work-items only (no dual storage)
3. **Initialization timing?** → At `/workflow:triage` (first stage entry)

## Gitignore Updates Required

Add to `.gitignore` and `docs/.gitignore.worksystem`:

```gitignore
# Work item ephemeral files (user-specific)
work-items/*/session-notes.md
```

## Success Criteria

- [ ] `work-items/` directory structure defined in schema
- [ ] `/workflow:triage` creates work-item directory automatically
- [ ] Activity log captures stage transitions
- [ ] Document writer outputs to work-item directory
- [ ] `/workflow:resume` can read activity log for context recovery
- [ ] ADR-0006 documents the decision

## References

- Inspiration: `/home/cbryant/projects/link/atlas/dev-support/tasks/tw-26253606/`
- Session logging: [ADR-0002](../adrs/0002-local-first-session-state.md)
- Document writer: [document-writer-agent.md](../agents/document-writer-agent.md)
